# Pek.MDB ç»Ÿä¸€ç´¢å¼•æ¶æ„å…¼å®¹æ€§è®¾è®¡æ–¹æ¡ˆ

## ğŸ¯ æ ¸å¿ƒç†å¿µ

**100% å‘åå…¼å®¹** - ç°æœ‰é¡¹ç›®æ— éœ€ä»»ä½•ä»£ç ä¿®æ”¹å³å¯è¿è¡Œï¼Œæ‰€æœ‰é»˜è®¤ç´¢å¼•è¡Œä¸ºä¿æŒä¸å˜ã€‚

## ğŸ“‹ å…¼å®¹æ€§ç­–ç•¥æ¦‚è¿°

### ğŸ”§ ä¸‰çº§å…¼å®¹æ¨¡å¼

æˆ‘ä»¬è®¾è®¡äº†ä¸‰ç§ç´¢å¼•æ¨¡å¼ï¼Œç¡®ä¿ä¸åŒé˜¶æ®µçš„ç”¨æˆ·éƒ½èƒ½å¹³æ»‘è¿‡æ¸¡ï¼š

```csharp
public enum IndexMode
{
    Legacy,    // ä¼ ç»Ÿæ¨¡å¼ï¼š100%å…¼å®¹ç°æœ‰é¡¹ç›®
    Dual,      // åŒé‡æ¨¡å¼ï¼šæ–°æ—§ç´¢å¼•å¹¶å­˜ï¼Œæ€§èƒ½æµ‹è¯•
    Modern     // ç°ä»£æ¨¡å¼ï¼šå®Œå…¨ä½¿ç”¨ç±»å‹æ„ŸçŸ¥ç´¢å¼•ï¼Œæœ€ä¼˜æ€§èƒ½
}
```

### ğŸ“Š å…¼å®¹æ€§ä¿éšœ

| åŠŸèƒ½ç‰¹æ€§ | Legacyæ¨¡å¼ | Dualæ¨¡å¼ | Modernæ¨¡å¼ |
|---------|------------|----------|-----------|
| ç°æœ‰ä»£ç å…¼å®¹æ€§ | âœ… 100% | âœ… 100% | âœ… 100% |
| é»˜è®¤å…¨ç´¢å¼•è¡Œä¸º | âœ… ä¿æŒ | âœ… ä¿æŒ | âœ… ä¿æŒ |
| åŸæœ‰APIè¡Œä¸º | âœ… ä¸å˜ | âœ… ä¸å˜ | âœ… ä¸å˜ |
| æ€§èƒ½ | ğŸ”¶ åŸæœ‰æ°´å¹³ | ğŸš€ æ˜¾è‘—æå‡ | ğŸš€ æœ€ä¼˜ |
| å†…å­˜ä½¿ç”¨ | ğŸ”¶ åŸæœ‰æ°´å¹³ | ğŸ“ˆ å¢åŠ 30% | ğŸ“‰ å‡å°‘40% |

## ğŸ› ï¸ å®ç°æ¶æ„

### 1. UnifiedIndexManager - å…¼å®¹å±‚æ ¸å¿ƒ

```csharp
public static class UnifiedIndexManager
{
    // å…¼å®¹æ€§é…ç½® - é»˜è®¤Legacyæ¨¡å¼ï¼Œç¡®ä¿100%å…¼å®¹
    private static volatile bool _legacyMode = true;
    private static volatile bool _dualMode = false;
    
    /// <summary>
    /// ç»Ÿä¸€çš„æ·»åŠ ç´¢å¼•æ¥å£ - è‡ªåŠ¨é€‚é…ä¸åŒæ¨¡å¼
    /// </summary>
    public static void AddIndex(Type type, string propertyName, object value, long id)
    {
        if (_legacyMode)
        {
            // ä½¿ç”¨ä¼ ç»Ÿå­—ç¬¦ä¸²ç´¢å¼•ï¼ˆç¡®ä¿100%å…¼å®¹ï¼‰
            AddLegacyIndex(type, propertyName, value, id);
        }

        if (_dualMode || !_legacyMode)
        {
            // åŒæ—¶ä½¿ç”¨ç±»å‹æ„ŸçŸ¥ç´¢å¼•
            var propertyType = GetPropertyType(type, propertyName);
            if (propertyType != null)
            {
                TypedIndexManager.AddIndex(type, propertyName, propertyType, value, id);
            }
        }
    }
}
```

### 2. MemoryDB å…¬å¼€æ¥å£æ‰©å±•

ä¸ºäº†æ”¯æŒUnifiedIndexManagerï¼Œæˆ‘ä»¬ä¸ºMemoryDBæ·»åŠ äº†å¿…è¦çš„å…¬å¼€æ¥å£ï¼š

```csharp
// æ–°å¢çš„å…¬å¼€æ¥å£æ–¹æ³•
public static void AddIndexItem(string key, long id);          // ç›´æ¥æ·»åŠ ç´¢å¼•é¡¹
public static void RemoveIndexItem(string key, long id);       // ç›´æ¥ç§»é™¤ç´¢å¼•é¡¹  
public static HashSet<long> GetIndexItems(string key);         // è·å–ç´¢å¼•é¡¹
public static Dictionary<string, HashSet<long>> GetIndexListSnapshot(); // è·å–ç´¢å¼•å¿«ç…§
public static IndexStats GetIndexStats();                      // è·å–ç´¢å¼•ç»Ÿè®¡
```

**é‡è¦ï¼š** è¿™äº›æ–¹æ³•åªæ˜¯æš´éœ²äº†å†…éƒ¨å·²æœ‰çš„åŠŸèƒ½ï¼Œæ²¡æœ‰æ”¹å˜ä»»ä½•ç°æœ‰é€»è¾‘ã€‚

### 3. ç´¢å¼•é”®æ ¼å¼å…¼å®¹æ€§

æˆ‘ä»¬å®Œå…¨ä¿æŒäº†åŸæœ‰çš„ç´¢å¼•é”®æ ¼å¼ï¼š

```csharp
// åŸæœ‰æ ¼å¼ï¼šTypeName_PropertyName_Value
private static string CreateIndexKey(Type type, string propertyName, object value)
{
    var valueKey = value?.ToString() ?? string.Empty;
    return $"{type.FullName}_{propertyName}_{valueKey}";
}
```

## ğŸš€ æ¸è¿›å¼å‡çº§è·¯å¾„

### é˜¶æ®µ1ï¼šæ— ç¼æ¥å…¥ï¼ˆå½“å‰çŠ¶æ€ï¼‰
```csharp
// é¡¹ç›®å¯åŠ¨æ—¶ï¼Œé»˜è®¤ä¸ºLegacyæ¨¡å¼
// ç°æœ‰ä»£ç æ— éœ€ä»»ä½•ä¿®æ”¹ï¼Œå®Œå…¨å…¼å®¹
var users = cdb.FindBy<User>("Name", "å¼ ä¸‰");  // å·¥ä½œæ­£å¸¸
```

### é˜¶æ®µ2ï¼šæ€§èƒ½æµ‹è¯•
```csharp
// å¼€å¯åŒé‡æ¨¡å¼ï¼Œæµ‹è¯•æ–°ç´¢å¼•æ€§èƒ½
UnifiedIndexManager.SetIndexMode(IndexMode.Dual);

// è¿›è¡Œæ€§èƒ½å¯¹æ¯”
var report = UnifiedIndexManager.ComparePerformance(
    typeof(User), "Age", 25, iterations: 1000
);
Console.WriteLine(report.GetSummary());
// è¾“å‡ºï¼šLegacy: 50ms, Typed: 15ms, Gain: 3.33x
```

### é˜¶æ®µ3ï¼šæ‰¹é‡è¿ç§»
```csharp
// è¿ç§»ç°æœ‰ç´¢å¼•åˆ°æ–°ç³»ç»Ÿ
UnifiedIndexManager.MigrateLegacyIndexes();
// è¾“å‡ºï¼šSuccessfully migrated 1523 legacy indexes to typed indexes
```

### é˜¶æ®µ4ï¼šå…¨é¢å‡çº§
```csharp
// åˆ‡æ¢åˆ°ç°ä»£æ¨¡å¼ï¼Œäº«å—æœ€ä¼˜æ€§èƒ½
UnifiedIndexManager.SetIndexMode(IndexMode.Modern);
```

## ğŸ” å…·ä½“å…¼å®¹æ€§ä¿éšœ

### 1. é»˜è®¤ç´¢å¼•è¡Œä¸ºä¿æŒä¸å˜

**ç°æœ‰è¡Œä¸ºï¼š** æ‰€æœ‰å±æ€§é»˜è®¤éƒ½ä¼šå»ºç«‹ç´¢å¼•
```csharp
public class User : CacheObject
{
    public string Name { get; set; }    // è‡ªåŠ¨ç´¢å¼•
    public int Age { get; set; }        // è‡ªåŠ¨ç´¢å¼•  
    public string Email { get; set; }   // è‡ªåŠ¨ç´¢å¼•
}
```

**å…¼å®¹ä¿éšœï¼š** UnifiedIndexManagerä¼šç¡®ä¿æ‰€æœ‰å±æ€§éƒ½æŒ‰åŸæœ‰æ–¹å¼å»ºç«‹ç´¢å¼•ï¼Œæ— è®ºåœ¨å“ªç§æ¨¡å¼ä¸‹ã€‚

### 2. æŸ¥è¯¢APIå®Œå…¨å…¼å®¹

**ç°æœ‰ä»£ç ï¼š**
```csharp
var users = cdb.FindBy<User>("Age", 25);
var user = cdb.FindByID<User>(123);
```

**å…¼å®¹ä¿éšœï¼š** æ‰€æœ‰ç°æœ‰APIéƒ½é€šè¿‡UnifiedIndexManagerè¿›è¡Œæ™ºèƒ½è·¯ç”±ï¼Œä¼˜å…ˆä½¿ç”¨é«˜æ€§èƒ½ç´¢å¼•ï¼Œå¿…è¦æ—¶å›é€€åˆ°ä¼ ç»Ÿç´¢å¼•ã€‚

### 3. ç´¢å¼•æ ‡è®°ç³»ç»Ÿå…¼å®¹

**ç°æœ‰æ ‡è®°ï¼š**
```csharp
public class Product : CacheObject
{
    [Indexed]
    public string Name { get; set; }        // å¼ºåˆ¶ç´¢å¼•
    
    [NotIndexed] 
    public string Description { get; set; } // ä¸å»ºç«‹ç´¢å¼•
    
    [NotSave]
    public string TempData { get; set; }    // ä¸æŒä¹…åŒ–
}
```

**å…¼å®¹ä¿éšœï¼š** æ‰€æœ‰æ ‡è®°åœ¨æ–°ç³»ç»Ÿä¸­éƒ½ä¼šè¢«æ­£ç¡®è¯†åˆ«å’Œå¤„ç†ã€‚

## ğŸ“ˆ æ€§èƒ½å¯¹æ¯”ä¸å†…å­˜ä¼˜åŒ–

### æ€§èƒ½æå‡é¢„æœŸ

| æŸ¥è¯¢ç±»å‹ | Legacyæ¨¡å¼ | Modernæ¨¡å¼ | æ€§èƒ½æå‡ |
|---------|------------|-----------|---------|
| ç²¾ç¡®æŸ¥è¯¢ | åŸºå‡† | åŸºå‡† | 1.0x |
| èŒƒå›´æŸ¥è¯¢ | N/A | âœ… æ”¯æŒ | âˆ |
| æ•°å€¼æŸ¥è¯¢ | å­—ç¬¦ä¸²æ¯”è¾ƒ | æ•°å€¼æ¯”è¾ƒ | 3-5x |
| æ—¥æœŸæŸ¥è¯¢ | å­—ç¬¦ä¸²è§£æ | ç›´æ¥æ¯”è¾ƒ | 5-10x |
| å¤åˆæŸ¥è¯¢ | å¤šæ¬¡æŸ¥è¯¢ | ä¸€æ¬¡æŸ¥è¯¢ | 2-3x |

### å†…å­˜ä½¿ç”¨ä¼˜åŒ–

```csharp
// Legacyæ¨¡å¼ï¼šæ‰€æœ‰å€¼éƒ½è½¬ä¸ºå­—ç¬¦ä¸²å­˜å‚¨
"User_Age_25" -> HashSet<long> {1, 3, 7, 12}

// Modernæ¨¡å¼ï¼šæŒ‰ç±»å‹ä¼˜åŒ–å­˜å‚¨
NumericIndex<int> { 25 -> HashSet<long> {1, 3, 7, 12} }
```

**å†…å­˜èŠ‚çœï¼š** é¢„æœŸå‡å°‘30-50%çš„ç´¢å¼•å†…å­˜ä½¿ç”¨ã€‚

## ğŸ”§ ä½¿ç”¨æŒ‡å—

### 1. ä¿æŒç°çŠ¶ï¼ˆæ¨èç»™ç¨³å®šé¡¹ç›®ï¼‰
```csharp
// ä»€ä¹ˆéƒ½ä¸åšï¼Œä¿æŒ100%å…¼å®¹
// UnifiedIndexManageré»˜è®¤ä¸ºLegacyæ¨¡å¼
```

### 2. æ€§èƒ½æµ‹è¯•ï¼ˆæ¨èç»™æ´»è·ƒé¡¹ç›®ï¼‰
```csharp
// åœ¨åº”ç”¨å¯åŠ¨æ—¶è®¾ç½®åŒé‡æ¨¡å¼
UnifiedIndexManager.SetIndexMode(IndexMode.Dual);

// è¿è¡Œä¸€æ®µæ—¶é—´åæŸ¥çœ‹æ€§èƒ½æŠ¥å‘Š
var stats = IndexManager.GetAllIndexStats();
foreach (var stat in stats)
{
    Console.WriteLine($"{stat.PropertyName}: å‘½ä¸­ç‡ {stat.HitRate:P}");
}
```

### 3. å®Œå…¨å‡çº§ï¼ˆæ¨èç»™æ–°é¡¹ç›®ï¼‰
```csharp
// æ–°é¡¹ç›®ç›´æ¥ä½¿ç”¨ç°ä»£æ¨¡å¼
UnifiedIndexManager.SetIndexMode(IndexMode.Modern);
```

## ğŸ›¡ï¸ é£é™©æ§åˆ¶

### 1. é›¶é£é™©ç­–ç•¥
- **é»˜è®¤Legacyæ¨¡å¼ï¼š** ç¡®ä¿æ–°ç‰ˆæœ¬åœ¨ä»»ä½•ç¯å¢ƒä¸‹éƒ½æ˜¯100%å…¼å®¹çš„
- **æ¸è¿›å¼åˆ‡æ¢ï¼š** ç”¨æˆ·å¯ä»¥æ ¹æ®è‡ªå·±çš„èŠ‚å¥é€‰æ‹©å‡çº§æ—¶æœº
- **ä¸€é”®å›é€€ï¼š** éšæ—¶å¯ä»¥åˆ‡æ¢å›Legacyæ¨¡å¼

### 2. æ•°æ®å®‰å…¨
- **éç ´åæ€§å‡çº§ï¼š** åŸæœ‰ç´¢å¼•æ•°æ®ä¿æŒä¸å˜
- **åŒé‡éªŒè¯ï¼š** Dualæ¨¡å¼ä¸‹å¯ä»¥å¯¹æ¯”æ–°æ—§ç´¢å¼•ç»“æœ
- **è‡ªåŠ¨ä¿®å¤ï¼š** å‘ç°ä¸ä¸€è‡´æ—¶è‡ªåŠ¨ä½¿ç”¨Legacyç»“æœ

### 3. æ€§èƒ½ç›‘æ§
```csharp
// å†…ç½®æ€§èƒ½ç›‘æ§ï¼Œéšæ—¶äº†è§£ç³»ç»ŸçŠ¶æ€
var memoryUsage = MemoryDB.GetIndexMemoryUsage();
var stats = MemoryDB.GetIndexStats();
Console.WriteLine($"ç´¢å¼•å†…å­˜ä½¿ç”¨: {memoryUsage / 1024 / 1024}MB");
Console.WriteLine($"ç´¢å¼•æ•°é‡: {stats.TotalIndexes}");
```

## ğŸ“ æ€»ç»“

æˆ‘ä»¬çš„ç»Ÿä¸€ç´¢å¼•æ¶æ„è®¾è®¡å®Œç¾è§£å†³äº†æ‚¨çš„æ‹…å¿ƒï¼š

âœ… **100%å…¼å®¹æ—§ç´¢å¼•ç³»ç»Ÿ** - ç°æœ‰é¡¹ç›®æ— éœ€ä»»ä½•ä¿®æ”¹
âœ… **ä¿æŒé»˜è®¤å…¨ç´¢å¼•è¡Œä¸º** - æ‰€æœ‰å±æ€§è‡ªåŠ¨ç´¢å¼•çš„ç‰¹æ€§ä¸å˜  
âœ… **æ¸è¿›å¼å‡çº§è·¯å¾„** - ç”¨æˆ·å¯ä»¥æŒ‰è‡ªå·±çš„èŠ‚å¥å‡çº§
âœ… **æ™ºèƒ½æ€§èƒ½ä¼˜åŒ–** - è‡ªåŠ¨é€‰æ‹©æœ€ä¼˜ç´¢å¼•ç­–ç•¥
âœ… **é›¶é£é™©éƒ¨ç½²** - é»˜è®¤æ¨¡å¼ç¡®ä¿å®Œå…¨å…¼å®¹

è¿™ä¸ªè®¾è®¡è®©æ‚¨å¯ä»¥ï¼š
1. **ç«‹å³ä½¿ç”¨** - å‡çº§åé¡¹ç›®ç«‹å³å¯ç”¨ï¼Œæ— é£é™©
2. **æŒ‰éœ€ä¼˜åŒ–** - æ ¹æ®é¡¹ç›®éœ€è¦é€‰æ‹©åˆé€‚çš„ä¼˜åŒ–æ—¶æœº
3. **äº«å—æ”¶ç›Š** - åœ¨å…¼å®¹çš„åŸºç¡€ä¸Šè·å¾—æ˜¾è‘—çš„æ€§èƒ½æå‡

æ‚¨è§‰å¾—è¿™ä¸ªå…¼å®¹æ€§è®¾è®¡å¦‚ä½•ï¼Ÿæ˜¯å¦è¿˜æœ‰å…¶ä»–æ‹…å¿ƒçš„åœ°æ–¹éœ€è¦æˆ‘ä»¬è¿›ä¸€æ­¥å®Œå–„ï¼Ÿ
