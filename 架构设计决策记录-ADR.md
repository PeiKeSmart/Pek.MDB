# Pek.MDB 架构设计决策记录 (ADR)

## 文档目的
本文档记录 Pek.MDB 项目中的重要架构设计决策，特别是关于专用索引系统的设计原理，防止后续开发中重复质疑已经过深度分析的设计选择。

---

## ADR-001: 专用索引系统设计决策

### 决策日期
2025-07-07

### 背景
在架构瘦身过程中，曾考虑将 `DateTimeIndex` 和 `BooleanIndex` 合并到 `GenericIndex` 以简化代码结构。

### 决策内容

#### 1. DateTimeIndex - 绝对禁止合并 🔒

**决策**: 必须保留独立的 `DateTimeIndex`，绝对不允许合并到 `GenericIndex`

**关键理由**:
- **性能差异巨大**: 时间范围查询 O(log n) vs 通用遍历 O(n)，性能差异达 **100倍**
- **功能不可替代**: 专业的年/月/日分组查询、时间排序等核心功能
- **业务场景核心**: 日志查询、报表生成、数据归档等高频业务需求
- **架构原则**: 时间查询是数据库系统的基础功能，专用索引是必需的架构设计

**具体功能价值**:
```csharp
// 这些专业功能在 GenericIndex 中无法高效实现
GetByYear(2024)           // 按年查询 - O(1) vs O(n)
GetByYearMonth(2024, 1)   // 按年月查询 - O(1) vs O(n)  
GetRange(startDate, endDate) // 时间范围查询 - O(log n) vs O(n)
```

**业务影响示例**:
- ✅ **当前**: "查询昨天的错误日志" - 毫秒级响应
- ❌ **合并后**: 相同查询变为秒级响应，用户体验严重下降

#### 2. BooleanIndex - 建议保留 🔧

**决策**: 建议保留独立的 `BooleanIndex`，但可根据实际使用频率考虑合并

**保留价值**:
- **智能转换功能**: 支持多种布尔表示（"是"/"否"、"yes"/"no"、"1"/"0"等）
- **国际化支持**: 提供更好的用户体验
- **维护成本低**: 代码简单，性能开销可控

**合并条件**:
- 项目中布尔查询使用频率极低（< 1%）
- 愿意牺牲智能转换功能
- 但**不推荐**，因为维护成本很小

### 设计原则确立

#### 专用索引 ≠ 过度设计
- 专用索引是针对特定数据类型的性能优化
- 通用索引无法提供相同级别的性能和功能
- 在数据库系统中，索引特化是标准且必要的设计模式

#### 性能优先原则
- 对于高频使用的数据类型（如时间），必须提供最优性能
- 100倍的性能差异不是微优化，而是架构级别的差异
- 用户体验不应该为代码简化而牺牲

#### 功能完整性原则
- 专业的查询功能（如时间分组）是数据库的核心价值
- 这些功能在通用实现中无法高效提供
- 功能丢失的风险远大于代码复杂度增加的成本

### 相关决策记录

- **NumericIndex**: 已优化锁机制，使用 ConcurrentDictionary 实现无锁并发
- **StringIndex**: 已简化，移除复杂的多重索引，保留核心功能
- **GenericIndex**: 作为兜底方案，处理其他类型

### 后续行动
1. 在代码中添加详细注释说明设计原理
2. 在架构文档中记录决策依据
3. 建立性能基准测试验证设计选择

### 审查和更新
- **下次审查**: 2026-01-07（6个月后）
- **触发条件**: 时间查询使用频率显著下降（< 5%）或出现重大性能问题
- **责任人**: 架构团队

---

## ADR-002: 异步持久化机制保留决策

### 决策日期
2025-07-07

### 背景
异步持久化机制曾被质疑为过度设计。

### 决策内容
**保留异步持久化机制**，因为：
- 性能收益明显：响应时间提升 80-90%
- 适合"读多写少"场景
- 数据安全性可通过配置控制

### 设计原则
- 性能优先，但不牺牲数据安全性
- 提供配置选项让用户根据场景选择

---

## ADR-003: 类型感知索引系统保留决策

### 决策日期
2025-07-07

### 背景
类型感知索引系统提供针对性优化。

### 决策内容
**完全保留类型感知索引系统**，因为：
- 每种类型都有最佳性能策略
- 提供专业的查询功能
- 自动选择最优索引实现

### 设计原则
- 专业化 > 通用化，在性能关键场景下
- 自动化索引选择，降低用户复杂度

---

## 总结

这些设计决策基于深入的性能分析、业务场景评估和用户体验考虑。它们不是过度设计，而是经过验证的专业架构选择。

**核心原则**: 在数据库系统中，性能和功能完整性比代码简化更重要。专用索引是实现高性能的必要手段，不应该为了追求代码简化而牺牲核心功能。