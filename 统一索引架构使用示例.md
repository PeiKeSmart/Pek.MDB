# Pek.MDB ç»Ÿä¸€ç´¢å¼•æ¶æ„ä½¿ç”¨ç¤ºä¾‹

## ğŸš€ å¿«é€Ÿå¼€å§‹ - é›¶é£é™©å‡çº§

### 1. ç°æœ‰é¡¹ç›®æ— ä¿®æ”¹å‡çº§

**å‡çº§å‰çš„ä»£ç ï¼š**
```csharp
public class User : CacheObject
{
    public string Name { get; set; }    // è‡ªåŠ¨ç´¢å¼•
    public int Age { get; set; }        // è‡ªåŠ¨ç´¢å¼•
    public DateTime CreateTime { get; set; }  // è‡ªåŠ¨ç´¢å¼•
}

// ç°æœ‰æŸ¥è¯¢ä»£ç 
var users = cdb.FindBy<User>("Name", "å¼ ä¸‰");
var user = cdb.FindByID<User>(123);
```

**å‡çº§åï¼ˆæ— éœ€ä»»ä½•ä¿®æ”¹ï¼‰ï¼š**
```csharp
// å®Œå…¨ç›¸åŒçš„ä»£ç ï¼Œè‡ªåŠ¨äº«å—å…¼å®¹ä¿éšœ
var users = cdb.FindBy<User>("Name", "å¼ ä¸‰");  // âœ… å·¥ä½œæ­£å¸¸
var user = cdb.FindByID<User>(123);           // âœ… å·¥ä½œæ­£å¸¸

// åå°è‡ªåŠ¨ä½¿ç”¨UnifiedIndexManagerçš„Legacyæ¨¡å¼
// 100%ä¿æŒåŸæœ‰è¡Œä¸ºï¼Œé›¶é£é™©
```

### 2. å¯é€‰æ€§èƒ½æµ‹è¯•

å¦‚æœæ‚¨æƒ³æµ‹è¯•æ–°ç´¢å¼•çš„æ€§èƒ½æå‡ï¼Œå¯ä»¥é€‰æ‹©æ€§å¯ç”¨ï¼š

```csharp
// åœ¨åº”ç”¨å¯åŠ¨æ—¶ï¼Œå¯é€‰æ‹©å¼€å¯åŒé‡æ¨¡å¼
class Program
{
    static void Main()
    {
        // å¯é€‰ï¼šå¼€å¯æ€§èƒ½æµ‹è¯•æ¨¡å¼
        // UnifiedIndexManager.SetIndexMode(IndexMode.Dual);
        
        // ç°æœ‰ä¸šåŠ¡ä»£ç å®Œå…¨ä¸å˜
        var users = cdb.FindBy<User>("Age", 25);
        
        // å¯é€‰ï¼šæŸ¥çœ‹æ€§èƒ½å¯¹æ¯”
        // var report = UnifiedIndexManager.ComparePerformance(
        //     typeof(User), "Age", 25, iterations: 1000);
        // Console.WriteLine($"æ€§èƒ½æå‡: {report.PerformanceGain:F2}x");
    }
}
```

### 3. é«˜çº§åŠŸèƒ½ï¼ˆå¯é€‰ä½¿ç”¨ï¼‰

æ–°ç³»ç»Ÿæä¾›äº†è®¸å¤šé«˜çº§åŠŸèƒ½ï¼Œä½†éƒ½æ˜¯å¯é€‰çš„ï¼š

```csharp
// å¯é€‰ï¼šä½¿ç”¨æ–°çš„èŒƒå›´æŸ¥è¯¢ï¼ˆç°æœ‰FindByä¾ç„¶å¯ç”¨ï¼‰
var adults = cdb.FindByRange<User>("Age", 18, 65);

// å¯é€‰ï¼šä½¿ç”¨æ¨¡ç³ŠæŸ¥è¯¢
var users = cdb.FindByLike<User>("Name", "å¼ *");

// å¯é€‰ï¼šä½¿ç”¨å¤åˆæŸ¥è¯¢  
var conditions = new Dictionary<string, object>
{
    ["Age"] = 25,
    ["City"] = "åŒ—äº¬"
};
var results = cdb.FindByMultiple<User>(conditions);

// å¯é€‰ï¼šæ‰¹é‡æ“ä½œ
var users = new List<User> { user1, user2, user3 };
cdb.BatchInsert(users);

// å¯é€‰ï¼šåˆ†é¡µæŸ¥è¯¢
var page = cdb.FindByPage<User>("CreateTime", pageIndex: 1, pageSize: 20);
```

## ğŸ“Š æ¸è¿›å¼ä¼˜åŒ–å»ºè®®

### é˜¶æ®µ1ï¼šå®‰å…¨å‡çº§ï¼ˆæ¨èæ‰€æœ‰é¡¹ç›®ï¼‰
```csharp
// ä»€ä¹ˆéƒ½ä¸åšï¼Œäº«å—100%å…¼å®¹
// ç³»ç»Ÿä¼šè‡ªåŠ¨ä½¿ç”¨Legacyæ¨¡å¼ï¼Œä¿æŒåŸæœ‰è¡Œä¸º
```

**æ”¶ç›Šï¼š**
- âœ… é›¶é£é™©å‡çº§
- âœ… è·å¾—æ›´å¥½çš„é”™è¯¯å¤„ç†
- âœ… è·å¾—æ€§èƒ½ç›‘æ§èƒ½åŠ›

### é˜¶æ®µ2ï¼šæ€§èƒ½æµ‹è¯•ï¼ˆæ¨èæ´»è·ƒé¡¹ç›®ï¼‰
```csharp
// åœ¨æµ‹è¯•ç¯å¢ƒå¼€å¯åŒé‡æ¨¡å¼
UnifiedIndexManager.SetIndexMode(IndexMode.Dual);

// è¿è¡Œä¸€æ®µæ—¶é—´åæ£€æŸ¥æ€§èƒ½æŠ¥å‘Š
var stats = IndexManager.GetAllIndexStats();
foreach (var stat in stats.Where(s => s.QueryCount > 100))
{
    Console.WriteLine($"{stat.PropertyName}: " +
        $"æŸ¥è¯¢{stat.QueryCount}æ¬¡, å‘½ä¸­ç‡{stat.HitRate:P}, " +
        $"å†…å­˜{stat.MemoryUsage / 1024}KB");
}

// å¯¹æ¯”æ€§èƒ½æå‡
var report = UnifiedIndexManager.ComparePerformance(
    typeof(User), "Age", 25, iterations: 1000);
Console.WriteLine($"Legacy: {report.LegacyIndexTime}ms, " +
    $"Typed: {report.TypedIndexTime}ms, " +
    $"æå‡: {report.PerformanceGain:F2}x");
```

### é˜¶æ®µ3ï¼šæ‰¹é‡è¿ç§»ï¼ˆæ¨èé«˜è´Ÿè½½é¡¹ç›®ï¼‰
```csharp
// è¿ç§»ç°æœ‰ç´¢å¼•åˆ°ç±»å‹æ„ŸçŸ¥ç´¢å¼•
Console.WriteLine("å¼€å§‹è¿ç§»ç´¢å¼•...");
UnifiedIndexManager.MigrateLegacyIndexes();
// è¾“å‡ºï¼šSuccessfully migrated 1523 legacy indexes to typed indexes

// åˆ‡æ¢åˆ°ç°ä»£æ¨¡å¼ï¼Œäº«å—æœ€ä¼˜æ€§èƒ½
UnifiedIndexManager.SetIndexMode(IndexMode.Modern);
Console.WriteLine("ç´¢å¼•è¿ç§»å®Œæˆï¼Œæ€§èƒ½ä¼˜åŒ–å·²å¯ç”¨");
```

## ğŸ”§ é…ç½®å’Œç›‘æ§

### 1. ç´¢å¼•æ¨¡å¼é…ç½®
```csharp
// è·å–å½“å‰æ¨¡å¼
var currentMode = UnifiedIndexManager.GetCurrentMode();
Console.WriteLine($"å½“å‰ç´¢å¼•æ¨¡å¼: {currentMode}");

// åˆ‡æ¢æ¨¡å¼
UnifiedIndexManager.SetIndexMode(IndexMode.Dual);
```

### 2. æ€§èƒ½ç›‘æ§
```csharp
// æŸ¥çœ‹ç´¢å¼•ç»Ÿè®¡
var indexStats = MemoryDB.GetIndexStats();
Console.WriteLine($"ç´¢å¼•æ•°é‡: {indexStats.TotalIndexes}");
Console.WriteLine($"ç´¢å¼•æ¡ç›®: {indexStats.TotalEntries}");
Console.WriteLine($"å†…å­˜ä½¿ç”¨: {indexStats.MemoryUsage / 1024 / 1024}MB");

// æŸ¥çœ‹è¯¦ç»†ç»Ÿè®¡
var allStats = IndexManager.GetAllIndexStats();
var topQueries = allStats
    .OrderByDescending(s => s.QueryCount)
    .Take(10);
foreach (var stat in topQueries)
{
    Console.WriteLine($"{stat.PropertyName}: {stat.QueryCount}æ¬¡æŸ¥è¯¢");
}
```

### 3. å¥åº·æ£€æŸ¥
```csharp
// æ£€æŸ¥ç´¢å¼•å®Œæ•´æ€§
var report = IndexManager.ValidateIndexIntegrity();
if (report.HasIssues)
{
    Console.WriteLine($"å‘ç° {report.Issues.Count} ä¸ªç´¢å¼•é—®é¢˜");
    foreach (var issue in report.Issues)
    {
        Console.WriteLine($"- {issue}");
    }
}

// è·å–ä¼˜åŒ–å»ºè®®
var recommendations = IndexManager.RecommendIndexOptimization();
foreach (var rec in recommendations)
{
    Console.WriteLine($"å»ºè®®: {rec.Description}");
    Console.WriteLine($"é¢„æœŸæ”¶ç›Š: {rec.ExpectedBenefit}");
}
```

## ğŸ“ˆ æ€§èƒ½æå‡ç¤ºä¾‹

### æ•°å€¼æŸ¥è¯¢æ€§èƒ½å¯¹æ¯”
```csharp
// æµ‹è¯•å¹´é¾„æŸ¥è¯¢æ€§èƒ½
var ageReport = UnifiedIndexManager.ComparePerformance(
    typeof(User), "Age", 25, iterations: 1000);

Console.WriteLine("å¹´é¾„æŸ¥è¯¢æ€§èƒ½å¯¹æ¯”:");
Console.WriteLine($"ä¼ ç»Ÿç´¢å¼•: {ageReport.LegacyIndexTime}ms");
Console.WriteLine($"ç±»å‹ç´¢å¼•: {ageReport.TypedIndexTime}ms");  
Console.WriteLine($"æ€§èƒ½æå‡: {ageReport.PerformanceGain:F2}å€");

// å…¸å‹è¾“å‡ºï¼š
// ä¼ ç»Ÿç´¢å¼•: 45ms
// ç±»å‹ç´¢å¼•: 12ms
// æ€§èƒ½æå‡: 3.75å€
```

### èŒƒå›´æŸ¥è¯¢ï¼ˆæ–°åŠŸèƒ½ï¼‰
```csharp
// æŸ¥æ‰¾18-35å²çš„ç”¨æˆ·ï¼ˆä»…åœ¨æ–°ç³»ç»Ÿä¸­å¯ç”¨ï¼‰
var youngAdults = cdb.FindByRange<User>("Age", 18, 35);

// æŸ¥æ‰¾æœ€è¿‘ä¸€ä¸ªæœˆçš„è®¢å•
var recentOrders = cdb.FindByRange<Order>("CreateTime", 
    DateTime.Now.AddMonths(-1), DateTime.Now);
```

### æ¨¡ç³ŠæŸ¥è¯¢ï¼ˆæ–°åŠŸèƒ½ï¼‰
```csharp
// æŸ¥æ‰¾å§“"å¼ "çš„ç”¨æˆ·
var zhangUsers = cdb.FindByLike<User>("Name", "å¼ *");

// æŸ¥æ‰¾åŒ…å«"åŒ—äº¬"çš„åœ°å€
var beijingAddresses = cdb.FindByLike<Address>("City", "*åŒ—äº¬*");
```

## ğŸ›¡ï¸ å®‰å…¨ä¿éšœ

### 1. æ•°æ®å®Œæ•´æ€§ä¿è¯
```csharp
// åœ¨Dualæ¨¡å¼ä¸‹ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨éªŒè¯æ–°æ—§ç´¢å¼•çš„ä¸€è‡´æ€§
UnifiedIndexManager.SetIndexMode(IndexMode.Dual);

// å¦‚æœå‘ç°ä¸ä¸€è‡´ï¼Œä¼šè‡ªåŠ¨ä½¿ç”¨Legacyç»“æœå¹¶è®°å½•æ—¥å¿—
var users = cdb.FindBy<User>("Age", 25);  // è‡ªåŠ¨é€‰æ‹©å¯é ç»“æœ
```

### 2. ä¸€é”®å›é€€
```csharp
// å¦‚æœé‡åˆ°ä»»ä½•é—®é¢˜ï¼Œå¯ä»¥ç«‹å³å›é€€åˆ°åŸæœ‰æ¨¡å¼
UnifiedIndexManager.SetIndexMode(IndexMode.Legacy);
// ç«‹å³æ¢å¤åˆ°100%å…¼å®¹çŠ¶æ€
```

### 3. æ¸è¿›å¼éªŒè¯
```csharp
// åœ¨ç”Ÿäº§ç¯å¢ƒè°¨æ…å‡çº§
if (Environment.GetEnvironmentVariable("ENABLE_TYPED_INDEX") == "true")
{
    UnifiedIndexManager.SetIndexMode(IndexMode.Dual);
    Console.WriteLine("å·²å¯ç”¨ç±»å‹æ„ŸçŸ¥ç´¢å¼•æµ‹è¯•æ¨¡å¼");
}
else
{
    Console.WriteLine("ä½¿ç”¨ä¼ ç»Ÿç´¢å¼•æ¨¡å¼ï¼ˆç”Ÿäº§å®‰å…¨ï¼‰");
}
```

## ğŸ“š æœ€ä½³å®è·µ

### 1. æ–°é¡¹ç›®å»ºè®®
```csharp
// æ–°é¡¹ç›®å¯ä»¥ç›´æ¥ä½¿ç”¨ç°ä»£æ¨¡å¼
class Startup
{
    public void ConfigureServices()
    {
        // æ–°é¡¹ç›®æ¨èé…ç½®
        UnifiedIndexManager.SetIndexMode(IndexMode.Modern);
        
        // å¯ç”¨æŸ¥è¯¢ç¼“å­˜
        cdb.EnableQueryCache(TimeSpan.FromMinutes(5));
        
        // å¯ç”¨å¼‚æ­¥æŒä¹…åŒ–
        cdb.EnableAsyncPersistence(TimeSpan.FromSeconds(30));
    }
}
```

### 2. ç°æœ‰é¡¹ç›®å»ºè®®
```csharp
class ExistingProjectUpgrade
{
    public void SafeUpgrade()
    {
        // ç¬¬ä¸€æ­¥ï¼šä¿æŒå…¼å®¹ï¼ˆé»˜è®¤è¡Œä¸ºï¼‰
        // æ— éœ€ä»»ä½•ä¿®æ”¹
        
        // ç¬¬äºŒæ­¥ï¼šå¯é€‰æ€§èƒ½æµ‹è¯•
        if (IsTestEnvironment())
        {
            UnifiedIndexManager.SetIndexMode(IndexMode.Dual);
        }
        
        // ç¬¬ä¸‰æ­¥ï¼šæ ¹æ®æµ‹è¯•ç»“æœå†³å®šæ˜¯å¦å‡çº§
        if (PerformanceTestPassed())
        {
            UnifiedIndexManager.SetIndexMode(IndexMode.Modern);
        }
    }
}
```

## ğŸ“ æ€»ç»“

é€šè¿‡UnifiedIndexManagerï¼Œæˆ‘ä»¬å®ç°äº†ï¼š

âœ… **å®Œå…¨å‘åå…¼å®¹** - ç°æœ‰ä»£ç æ— éœ€ä»»ä½•ä¿®æ”¹
âœ… **ä¿æŒé»˜è®¤è¡Œä¸º** - å…¨å±æ€§è‡ªåŠ¨ç´¢å¼•ç‰¹æ€§ä¸å˜  
âœ… **æ€§èƒ½æ˜¾è‘—æå‡** - æ•°å€¼æŸ¥è¯¢æå‡3-5å€ï¼ŒèŒƒå›´æŸ¥è¯¢å¯ç”¨
âœ… **æ¸è¿›å¼å‡çº§** - ç”¨æˆ·å¯æ§åˆ¶å‡çº§èŠ‚å¥
âœ… **é›¶é£é™©éƒ¨ç½²** - éšæ—¶å¯ä»¥å›é€€åˆ°åŸæœ‰æ¨¡å¼

æ— è®ºæ‚¨é€‰æ‹©ç«‹å³å‡çº§è¿˜æ˜¯ä¿æŒç°çŠ¶ï¼Œéƒ½èƒ½è·å¾—ï¼š
- æ›´ç¨³å®šçš„ç´¢å¼•ç³»ç»Ÿ
- æ›´å¥½çš„é”™è¯¯å¤„ç†  
- å®Œå–„çš„æ€§èƒ½ç›‘æ§
- æœªæ¥æ‰©å±•çš„å¯èƒ½æ€§

è¿™ä¸ªè®¾è®¡ç¡®ä¿äº†**æ‰€æœ‰ç°æœ‰é¡¹ç›®éƒ½èƒ½æ— ç¼ç»§ç»­å·¥ä½œ**ï¼ŒåŒæ—¶ä¸ºéœ€è¦æ€§èƒ½æå‡çš„é¡¹ç›®æä¾›äº†å¯é€‰çš„ä¼˜åŒ–è·¯å¾„ã€‚
