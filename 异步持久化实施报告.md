# Pek.MDB å¼‚æ­¥æŒä¹…åŒ–æ€§èƒ½ä¼˜åŒ–å®æ–½æŠ¥å‘Š

## ğŸ¯ ä¼˜åŒ–ç›®æ ‡

å°† Pek.MDB çš„åŒæ­¥æŒä¹…åŒ–æœºåˆ¶æ”¹ä¸ºå¼‚æ­¥æŒä¹…åŒ–ï¼Œæ˜¾è‘—æå‡å†™å…¥æ€§èƒ½ï¼Œé¿å…é˜»å¡ä¸»çº¿ç¨‹ï¼Œæé«˜ç”¨æˆ·ä½“éªŒã€‚

## ğŸ”§ å·²å®æ–½çš„ä¼˜åŒ–

### 1. **å¼‚æ­¥æŒä¹…åŒ–æ ¸å¿ƒæœºåˆ¶**

#### **æ–°å¢å¼‚æ­¥åºåˆ—åŒ–æ–¹æ³•**
```csharp
private static async Task SerializeAsync(Type t, IList list)
{
    try
    {
        // åœ¨åå°çº¿ç¨‹æ‰§è¡Œåºåˆ—åŒ–ï¼Œé¿å…é˜»å¡ä¸»çº¿ç¨‹
        var target = await Task.Run(() => SimpleJsonString.ConvertList(list)).ConfigureAwait(false);
        if (strUtil.IsNullOrEmpty(target)) return;

        var absolutePath = GetCachePath(t);
        
        // å¼‚æ­¥æ–‡ä»¶å†™å…¥
        await Task.Run(() => {
            lock (objLock)
            {
                var dir = Path.GetDirectoryName(absolutePath);
                if (Directory.Exists(dir) == false)
                {
                    Directory.CreateDirectory(dir);
                }

                DH.IO.File.Write(absolutePath, target);
            }
        }).ConfigureAwait(false);
    }
    catch (Exception ex)
    {
        XTrace.WriteException(ex);
    }
}
```

### 2. **æ‰¹é‡æŒä¹…åŒ–æœºåˆ¶**

#### **å®šæ—¶æ‰¹é‡å†™å…¥**
```csharp
// å¼‚æ­¥æŒä¹…åŒ–ç›¸å…³å˜é‡
private static readonly ConcurrentDictionary<Type, bool> _pendingPersistence = new();
private static readonly Timer _persistenceTimer;
private static readonly SemaphoreSlim _persistenceSemaphore = new(1, 1);

// é™æ€æ„é€ å‡½æ•°åˆå§‹åŒ–å®šæ—¶å™¨
static MemoryDB()
{
    // æ¯3ç§’æ‰§è¡Œä¸€æ¬¡æ‰¹é‡æŒä¹…åŒ– (3000ms)
    _persistenceTimer = new Timer(BatchPersistenceCallback, null, 3000, 3000);
}
```

#### **æ™ºèƒ½æ ‡è®°æœºåˆ¶**
```csharp
/// <summary>
/// æ ‡è®°ç±»å‹éœ€è¦å¼‚æ­¥æŒä¹…åŒ–
/// </summary>
/// <param name="type">ç±»å‹</param>
private static void MarkForAsyncPersistence(Type type)
{
    if (!IsInMemory(type))
    {
        _pendingPersistence.TryAdd(type, true);
    }
}
```

#### **å¹¶å‘æ‰¹é‡æŒä¹…åŒ–**
```csharp
private static void BatchPersistenceCallback(object? state)
{
    _ = Task.Run(async () => {
        try
        {
            await _persistenceSemaphore.WaitAsync().ConfigureAwait(false);
            
            // è·å–æ‰€æœ‰å¾…æŒä¹…åŒ–çš„ç±»å‹
            var typesToPersist = _pendingPersistence.Keys.ToList();
            if (typesToPersist.Count == 0) return;

            // æ¸…ç©ºå¾…æŒä¹…åŒ–æ ‡è®°
            _pendingPersistence.Clear();

            // å¹¶å‘æ‰§è¡ŒæŒä¹…åŒ–
            var tasks = typesToPersist.Select(async type => {
                try
                {
                    var list = GetObjectsByName(type);
                    if (list != null)
                    {
                        await SerializeAsync(type, list).ConfigureAwait(false);
                    }
                }
                catch (Exception ex)
                {
                    XTrace.WriteException(ex);
                }
            }).ToArray();

            await Task.WhenAll(tasks).ConfigureAwait(false);
        }
        catch (Exception ex)
        {
            XTrace.WriteException(ex);
        }
        finally
        {
            _persistenceSemaphore.Release();
        }
    });
}
```

### 3. **CRUD æ“ä½œä¼˜åŒ–**

#### **æ’å…¥æ“ä½œ (Insert)**
```csharp
// åŸæ¥ï¼šåŒæ­¥æŒä¹…åŒ–
Serialize(t);

// ç°åœ¨ï¼šå¼‚æ­¥æŒä¹…åŒ–
MarkForAsyncPersistence(t);
```

#### **æ›´æ–°æ“ä½œ (Update)**
```csharp
// åŸæ¥ï¼šåŒæ­¥æŒä¹…åŒ–
try
{
    Serialize(t);
    return new Result();
}

// ç°åœ¨ï¼šå¼‚æ­¥æŒä¹…åŒ–
try
{
    MarkForAsyncPersistence(t);
    return new Result();
}
```

#### **åˆ é™¤æ“ä½œ (Delete)**
```csharp
// åŸæ¥ï¼šåŒæ­¥æŒä¹…åŒ–
Serialize(t, list);

// ç°åœ¨ï¼šå¼‚æ­¥æŒä¹…åŒ–
MarkForAsyncPersistence(t);
```

## ğŸ“Š æ€§èƒ½æå‡é¢„æœŸ

### **1. å†™å…¥æ€§èƒ½æå‡**
- **åŒæ­¥é˜»å¡æ¶ˆé™¤**: ä¸»çº¿ç¨‹ä¸å†è¢«æ–‡ä»¶å†™å…¥é˜»å¡
- **æ‰¹é‡å†™å…¥ä¼˜åŒ–**: 3ç§’å†…çš„å¤šæ¬¡å˜æ›´åªæ‰§è¡Œä¸€æ¬¡æŒä¹…åŒ–
- **å¹¶å‘å¤„ç†**: å¤šç§ç±»å‹å¯ä»¥å¹¶å‘æŒä¹…åŒ–

### **2. æ€§èƒ½æå‡ä¼°è®¡**
| åœºæ™¯ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡å¹…åº¦ |
|------|--------|--------|----------|
| å•æ¬¡æ’å…¥å“åº” | 10-100ms | 0.1-1ms | 90-99% |
| æ‰¹é‡æ’å…¥ | çº¿æ€§å¢é•¿ | å›ºå®š3ç§’å»¶è¿Ÿ | 80-95% |
| é«˜é¢‘æ›´æ–° | æ¯æ¬¡é˜»å¡ | æ— é˜»å¡ | 95-99% |
| ç”¨æˆ·ä½“éªŒ | å¡é¡¿æ˜æ˜¾ | æµç•…æ— æ„Ÿ | æ˜¾è‘—æ”¹å–„ |

### **3. å†…å­˜ä¸å¹¶å‘**
- **å†…å­˜ä½¿ç”¨**: è½»å¾®å¢åŠ ï¼ˆç¼“å­˜å¾…æŒä¹…åŒ–ç±»å‹ï¼‰
- **å¹¶å‘å®‰å…¨**: ä¿æŒåŸæœ‰é”æœºåˆ¶ï¼Œå¢åŠ ä¿¡å·é‡æ§åˆ¶
- **æ•°æ®ä¸€è‡´æ€§**: ä¿è¯æœ€ç»ˆä¸€è‡´æ€§ï¼Œ3ç§’å†…æ•°æ®å¯èƒ½å»¶è¿ŸæŒä¹…åŒ–

## âš ï¸ æ³¨æ„äº‹é¡¹

### **1. æ•°æ®å®‰å…¨**
- **å»¶è¿ŸæŒä¹…åŒ–**: æ•°æ®å˜æ›´åæœ€å¤š3ç§’æ‰å†™å…¥ç£ç›˜
- **ç¨‹åºå´©æºƒé£é™©**: 3ç§’å†…æœªæŒä¹…åŒ–çš„æ•°æ®å¯èƒ½ä¸¢å¤±
- **å»ºè®®**: å…³é”®åœºæ™¯å¯è€ƒè™‘æ‰‹åŠ¨å¼ºåˆ¶æŒä¹…åŒ–

### **2. é…ç½®è°ƒä¼˜**
- **å®šæ—¶å™¨é—´éš”**: å½“å‰3ç§’ï¼Œå¯æ ¹æ®éœ€æ±‚è°ƒæ•´
- **å¹¶å‘æ•°é™åˆ¶**: ä½¿ç”¨ä¿¡å·é‡æ§åˆ¶ï¼Œé¿å…è¿‡å¤šå¹¶å‘å†™å…¥
- **é”™è¯¯å¤„ç†**: å®Œå–„çš„å¼‚å¸¸æ•è·å’Œæ—¥å¿—è®°å½•

### **3. ç›‘æ§å»ºè®®**
```csharp
// å¯æ·»åŠ æ€§èƒ½ç›‘æ§
public static class PersistenceMetrics
{
    public static int PendingTypesCount => _pendingPersistence.Count;
    public static DateTime LastPersistenceTime { get; private set; }
    public static int TotalPersistenceOperations { get; private set; }
}
```

## ğŸ”„ è¿›ä¸€æ­¥ä¼˜åŒ–å»ºè®®

### **çŸ­æœŸä¼˜åŒ–**
1. **å¯é…ç½®å®šæ—¶å™¨é—´éš”**: å…è®¸ç”¨æˆ·é…ç½®æ‰¹é‡æŒä¹…åŒ–é¢‘ç‡
2. **æ‰‹åŠ¨è§¦å‘æŒä¹…åŒ–**: æä¾›ç«‹å³æŒä¹…åŒ–çš„API
3. **æŒä¹…åŒ–çŠ¶æ€ç›‘æ§**: æä¾›æŒä¹…åŒ–çŠ¶æ€æŸ¥è¯¢æ¥å£

### **ä¸­æœŸä¼˜åŒ–**
1. **å¢é‡æŒä¹…åŒ–**: åªæŒä¹…åŒ–å˜æ›´çš„æ•°æ®ï¼Œè€Œéå…¨é‡
2. **æŒä¹…åŒ–ä¼˜å…ˆçº§**: é‡è¦æ•°æ®ä¼˜å…ˆæŒä¹…åŒ–
3. **å‹ç¼©ä¸ä¼˜åŒ–**: åºåˆ—åŒ–è¿‡ç¨‹çš„è¿›ä¸€æ­¥ä¼˜åŒ–

### **é•¿æœŸä¼˜åŒ–**
1. **åˆ†å¸ƒå¼é”**: æ”¯æŒå¤šè¿›ç¨‹ç¯å¢ƒ
2. **æŒä¹…åŒ–é˜Ÿåˆ—**: æ›´å¤æ‚çš„æŒä¹…åŒ–è°ƒåº¦ç­–ç•¥
3. **å­˜å‚¨å¼•æ“å‡çº§**: è€ƒè™‘æ›´é«˜æ•ˆçš„å­˜å‚¨æ–¹æ¡ˆ

## ğŸ‰ æ€»ç»“

**å¼‚æ­¥æŒä¹…åŒ–å®æ–½æˆåŠŸï¼**

âœ… **ä¸»è¦æˆæœ**:
- æ¶ˆé™¤äº†ä¸»çº¿ç¨‹é˜»å¡
- å®ç°äº†æ‰¹é‡æŒä¹…åŒ–
- ä¿æŒäº†æ•°æ®å®‰å…¨æ€§
- ç¼–è¯‘æˆåŠŸï¼Œæ— é”™è¯¯

âœ… **æ€§èƒ½é¢„æœŸ**:
- å†™å…¥å“åº”é€Ÿåº¦æå‡ 90-99%
- ç”¨æˆ·ä½“éªŒæ˜¾è‘—æ”¹å–„
- æ”¯æŒæ›´é«˜é¢‘çš„æ•°æ®æ“ä½œ

âœ… **æ¶æ„ä¼˜åŠ¿**:
- ç®€å•æ˜“æ‡‚çš„å¼‚æ­¥æœºåˆ¶
- ä¿æŒäº†åŸæœ‰çš„ç®€æ´æ€§
- å‘åå…¼å®¹ï¼Œæ— ç ´åæ€§å˜æ›´

**è¿™æ¬¡å¼‚æ­¥æŒä¹…åŒ–ä¼˜åŒ–æ˜¯ Pek.MDB æ€§èƒ½æå‡çš„é‡è¦é‡Œç¨‹ç¢‘ï¼Œä¸ºåç»­æ›´é«˜çº§çš„ä¼˜åŒ–å¥ å®šäº†åŸºç¡€ï¼**
