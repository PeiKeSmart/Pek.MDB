# 数据类型感知索引系统使用指南

## 概述

数据类型感知索引系统是对 Pek.MDB 原有索引系统的重大升级，它能够根据属性的数据类型自动选择最适合的索引实现，提供更强大的查询功能和更好的性能。

## 核心特性

### 1. 类型感知索引
- **数值索引 (NumericIndex)**: 支持范围查询，适用于 int、long、decimal、double 等数值类型
- **字符串索引 (StringIndex)**: 支持模糊查询、前缀/后缀匹配，包含完整的文本搜索功能
- **日期时间索引 (DateTimeIndex)**: 支持时间范围查询和按年/月/日分组查询
- **布尔索引 (BooleanIndex)**: 专门优化的布尔值索引
- **通用索引 (GenericIndex)**: 处理其他复杂类型

### 2. 新增查询功能
- **范围查询**: `FindByRange()` - 支持数值和日期范围
- **模糊查询**: `FindByLike()` - 支持通配符匹配
- **复合查询**: `FindByMultiple()` - 多条件组合查询
- **批量查询**: `FindByIds()` - 批量ID查询
- **分页查询**: `FindByPage()` - 支持排序的分页功能

### 3. 索引监控和优化
- **性能统计**: 查询次数、命中率、内存使用等
- **优化建议**: 自动分析索引使用情况并提供优化建议
- **完整性检查**: 验证索引健康状态
- **性能报告**: 生成详细的索引性能分析报告

## 使用方法

### 基本查询

```csharp
// 传统精确查询（保持向后兼容）
var products = cdb.FindBy<Product>("Name", "iPhone");

// 数值范围查询
var expensiveProducts = cdb.FindByRange<Product>("Price", 1000m, 5000m);

// 日期范围查询  
var recentOrders = cdb.FindByDateRange<Order>("CreateTime", 
    DateTime.Now.AddDays(-7), DateTime.Now);

// 字符串模糊查询
var searchResults = cdb.FindByLike<Product>("Name", "*iPhone*");

// 前缀匹配
var appleProducts = cdb.FindByStartsWith<Product>("Name", "Apple");

// 后缀匹配
var proModels = cdb.FindByEndsWith<Product>("Name", "Pro");

// 包含查询
var phoneProducts = cdb.FindByContains<Product>("Description", "手机");
```

### 复合查询

```csharp
// 多条件查询
var conditions = new Dictionary<string, object>
{
    { "CategoryId", "electronics" },
    { "IsActive", true },
    { "Stock", 10 }  // 库存大于等于10
};
var results = cdb.FindByMultiple<Product>(conditions);
```

### 分页查询

```csharp
// 按价格排序的分页查询
var pagedResult = cdb.FindByPage<Product>("Price", pageIndex: 0, pageSize: 20, ascending: false);

Console.WriteLine($"总共 {pagedResult.TotalCount} 条记录，{pagedResult.TotalPages} 页");
foreach (var product in pagedResult.Items)
{
    Console.WriteLine($"{product.Name}: {product.Price:C}");
}
```

### 批量查询

```csharp
// 批量获取指定ID的产品
var ids = new long[] { 1, 2, 3, 4, 5 };
var productMap = cdb.FindByIds<Product>(ids);
```

## 配置和管理

### 启用/禁用类型感知索引

```csharp
// 启用类型感知索引（默认启用）
cdb.EnableTypedIndex(true);

// 检查是否启用
bool isEnabled = cdb.IsTypedIndexEnabled();
```

### 索引监控

```csharp
// 获取所有索引统计信息
var stats = IndexManager.GetAllIndexStats();
foreach (var stat in stats)
{
    Console.WriteLine($"属性: {stat.PropertyName}");
    Console.WriteLine($"类型: {stat.IndexType}");
    Console.WriteLine($"查询次数: {stat.QueryCount}");
    Console.WriteLine($"命中率: {stat.HitRate:P}");
    Console.WriteLine($"内存使用: {stat.MemoryUsage / 1024:F1} KB");
    Console.WriteLine("---");
}

// 获取优化建议
var recommendations = IndexManager.RecommendIndexOptimization();
foreach (var rec in recommendations)
{
    Console.WriteLine($"[{rec.Priority}] {rec.PropertyName}: {rec.Recommendation}");
}

// 生成性能报告
string report = IndexManager.GeneratePerformanceReport();
Console.WriteLine(report);

// 验证索引完整性
var integrityReport = IndexManager.ValidateIndexIntegrity();
Console.WriteLine($"索引健康状态: {(integrityReport.IsHealthy ? "良好" : "需要关注")}");
```

## 性能优化建议

### 1. 属性标记优化
使用索引标记来精确控制哪些属性需要索引：

```csharp
public class Product : CacheObject
{
    [Indexed("主要查询字段")]
    public string Name { get; set; }
    
    [Indexed]
    public decimal Price { get; set; }
    
    [NotIndexed("大文本字段")]
    public string Description { get; set; }
    
    [NotSave]
    public bool IsOnline { get; set; }  // 运行时状态，不保存
}
```

### 2. 查询优化
- 对于范围查询，优先使用数值和日期类型的属性
- 复合查询时，将选择性最高的条件放在前面
- 使用分页查询避免一次性加载大量数据

### 3. 内存管理
- 定期检查索引使用情况，清理未使用的索引
- 监控内存使用，对于大文本字段考虑使用 `[NotIndexed]` 标记

## 向后兼容性

类型感知索引系统完全向后兼容：
- 现有代码无需修改即可继续工作
- 原有的 `FindBy()` 方法会自动使用类型感知索引（如果启用）
- 如果类型感知索引不可用，会自动降级到传统字符串索引

## 最佳实践

### 1. 索引设计
```csharp
public class Order : CacheObject
{
    [Indexed("订单号查询")]
    public string OrderNumber { get; set; }
    
    [Indexed("时间范围查询")]
    public DateTime CreateTime { get; set; }
    
    [Indexed("金额范围查询")]
    public decimal TotalAmount { get; set; }
    
    [Indexed("状态过滤")]
    public OrderStatus Status { get; set; }
    
    [NotIndexed("详细信息")]
    public string Details { get; set; }  // 大文本，不建立索引
}
```

### 2. 查询策略
```csharp
// 推荐：使用类型感知的范围查询
var orders = cdb.FindByDateRange<Order>("CreateTime", startDate, endDate);

// 推荐：组合查询条件
var conditions = new Dictionary<string, object>
{
    { "Status", OrderStatus.Pending },
    { "CreateTime", DateTime.Today }  // 今日订单
};
var todayPendingOrders = cdb.FindByMultiple<Order>(conditions);

// 推荐：分页处理大结果集
var pagedOrders = cdb.FindByPage<Order>("CreateTime", 0, 50, false);
```

### 3. 性能监控
```csharp
// 定期检查索引性能
var report = IndexManager.GeneratePerformanceReport();
File.WriteAllText("index_performance.md", report);

// 检查需要优化的索引
var recommendations = IndexManager.RecommendIndexOptimization();
var highPriorityIssues = recommendations
    .Where(r => r.Priority >= RecommendationPriority.Medium)
    .ToList();
```

## 总结

数据类型感知索引系统为 Pek.MDB 带来了以下改进：

1. **功能增强**: 支持范围查询、模糊查询、复合查询等高级功能
2. **性能优化**: 根据数据类型选择最适合的索引实现
3. **易于监控**: 提供完善的索引统计和优化建议
4. **完全兼容**: 保持与现有代码的100%兼容性
5. **智能管理**: 自动类型检测和索引策略选择

这一升级使得 Pek.MDB 在保持简单易用的同时，具备了企业级数据库的查询能力和性能特征。
