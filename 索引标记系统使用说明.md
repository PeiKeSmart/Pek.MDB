# 索引标记系统使用说明

## 概述

Pek.MDB 现已支持更精细的索引控制，通过新的属性标记系统，您可以精确控制哪些属性需要建立索引，哪些属性不需要索引，从而优化性能和内存使用。

## 标记类型

### 1. `[Indexed]` - 明确要求索引
```csharp
[Indexed]
public string CategoryId { get; set; }

[Indexed("重要查询字段")]
public string SupplierId { get; set; }

[Indexed(priority: 10, description: "高优先级索引")]
public string ImportantField { get; set; }
```

**用途：**
- 明确标记需要建立索引的属性
- 主要用于文档化重要的查询字段
- 提高代码可读性

### 2. `[NotIndexed]` - 不建立索引
```csharp
[NotIndexed]
public string Description { get; set; }

[NotIndexed("大文本字段，不适合建立索引")]
public string LongText { get; set; }
```

**用途：**
- 标记不需要建立索引的属性
- 适用于大文本字段、很少用于查询的字段
- 节省内存和提高索引性能

### 3. `[NotSave]` - 完全不保存
```csharp
[NotSave]
public decimal CalculatedValue { get; set; }

[NotSave]
public DateTime LastAccessTime { get; set; }
```

**用途：**
- 标记临时属性、计算属性
- 不参与索引、序列化、持久化
- 最高优先级，覆盖其他标记

## 标记优先级

索引系统按以下优先级处理属性：

1. **`[NotSave]`** - 最高优先级，完全不保存
2. **`[NotIndexed]`** - 中等优先级，不建立索引
3. **`[Indexed]`** - 低优先级，明确要求索引
4. **无标记** - 默认行为，建立索引（保持向后兼容）

## 兼容性说明

### 完全向后兼容
- 现有项目无需修改任何代码
- 默认所有属性都建立索引
- `NotSaveAttribute` 继续正常工作

### 渐进式采用
```csharp
// 旧代码 - 继续正常工作
public class OldProduct : CacheObject
{
    public string Name { get; set; }      // 默认建立索引
    public decimal Price { get; set; }    // 默认建立索引
    
    [NotSave]
    public string TempData { get; set; }  // 不保存不索引
}

// 新代码 - 使用新标记优化
public class NewProduct : CacheObject
{
    [Indexed("主要查询字段")]
    public string Name { get; set; }      // 明确要求索引
    
    public decimal Price { get; set; }    // 默认建立索引
    
    [NotIndexed("大文本字段")]
    public string Description { get; set; } // 保存但不索引
    
    [NotSave]
    public string TempData { get; set; }  // 不保存不索引
}
```

## 增量索引更新

新系统支持增量索引更新，只更新变化的属性索引：

```csharp
// 插入时建立完整索引
var product = new Product 
{ 
    Name = "Original", 
    Price = 100, 
    CategoryId = "CAT001" 
};
MemoryDB.Insert(product);

// 更新时只更新变化的属性索引
product.Name = "Updated";  // 只更新 Name 的索引
product.Price = 120;       // 只更新 Price 的索引
// CategoryId 未变化，索引保持不变
MemoryDB.Update(product);
```

## 性能优化建议

### 1. 大文本字段优化
```csharp
public class Article : CacheObject
{
    [Indexed]
    public string Title { get; set; }     // 经常查询，建立索引
    
    [NotIndexed("大文本内容")]
    public string Content { get; set; }   // 很少查询，不建立索引
    
    [NotIndexed("长文本")]
    public string Summary { get; set; }   // 不需要查询，不建立索引
}
```

### 2. 临时属性优化
```csharp
public class User : CacheObject
{
    [Indexed]
    public string Email { get; set; }     // 登录查询，建立索引
    
    public string Name { get; set; }      // 默认建立索引
    
    [NotSave]
    public bool IsOnline { get; set; }    // 运行时状态，不保存
    
    [NotSave]
    public DateTime LastSeen { get; set; } // 缓存时间，不保存
}
```

### 3. 批量数据优化
```csharp
public class LogEntry : CacheObject
{
    [Indexed("时间查询")]
    public DateTime Timestamp { get; set; }
    
    [Indexed("级别过滤")]
    public string Level { get; set; }
    
    [NotIndexed("详细信息")]
    public string Message { get; set; }   // 日志内容，不建立索引
    
    [NotIndexed("堆栈跟踪")]
    public string StackTrace { get; set; } // 错误详情，不建立索引
}
```

## 最佳实践

### 1. 标记策略
- 对经常用于查询的字段使用 `[Indexed]`
- 对大文本字段使用 `[NotIndexed]`
- 对临时计算属性使用 `[NotSave]`

### 2. 性能考量
- 索引会占用额外内存
- 过多索引会影响插入/更新性能
- 合理使用标记可以显著提升性能

### 3. 文档化
- 使用描述参数说明索引目的
- 添加注释解释标记选择的原因

## 示例代码

完整的使用示例请参考：
- `Examples/IndexAttributeDemo.cs` - 基本用法示例
- `Examples/IncrementalIndexDemo.cs` - 增量更新示例

## 迁移指南

### 从旧系统迁移
1. 现有代码无需修改，继续正常工作
2. 逐步添加新标记进行优化
3. 重点关注大文本字段和临时属性

### 性能测试
1. 使用 `IndexPerformanceTest` 验证性能提升
2. 监控内存使用情况
3. 测试查询响应时间

## 总结

新的索引标记系统提供了：
- **完全向后兼容** - 现有项目无需修改
- **精细控制** - 三种标记满足不同需求
- **增量更新** - 显著提升更新性能
- **渐进式采用** - 可以逐步优化现有代码

通过合理使用这些标记，您可以在保持功能完整性的同时，显著提升应用程序的性能和资源利用率。
